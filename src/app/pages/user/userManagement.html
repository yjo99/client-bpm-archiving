<!-- userManagement.html -->
<app-floating-configurator />
<style>
    /* Add to your component's CSS */
    .selected-groups-container {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    ::ng-deep .p-dialog-content {
        overflow-y: auto !important;
    }

    ::ng-deep .p-multiselect-panel {
        max-height: 200px !important;
    }

    .flex-wrap {
        flex-wrap: wrap;
    }

    .gap-1 {
        gap: 0.25rem;
    }

    .max-h-32 {
        max-height: 8rem;
    }
    /* Improved dialog styling */
    ::ng-deep .assignment-dialog .p-dialog-content {
        overflow-y: auto !important;
        padding: 1.5rem !important;
    }

    ::ng-deep .assignment-dialog .p-multiselect-panel {
        max-height: 200px !important;
        min-width: 300px !important;
    }

    ::ng-deep .assignment-dialog .p-multiselect {
        min-height: 44px;
    }

    .selected-groups-container {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
        ::ng-deep .assignment-dialog .p-dialog {
            width: 95vw !important;
            margin: 1rem !important;
        }

        ::ng-deep .assignment-dialog .p-dialog-content {
            padding: 1rem !important;
        }
    }

    /* Better tag styling */
    ::ng-deep .assignment-dialog .p-tag {
        display: flex !important;
        align-items: center !important;
        gap: 0.25rem !important;
    }

    ::ng-deep .assignment-dialog .p-tag .pi-times {
        font-size: 0.75rem !important;
        padding: 0.125rem !important;
        border-radius: 50% !important;
        background: rgba(255, 255, 255, 0.2) !important;
    }

    ::ng-deep .assignment-dialog .p-tag .pi-times:hover {
        background: rgba(255, 255, 255, 0.3) !important;
    }
</style>
<div class="p-4">
    <p-toast></p-toast>

    <div class="card mb-6">
        <h1>User Management Screen</h1>
    </div>

    <p-accordion [activeIndex]="activeIndex">
        <!-- Users Section -->
        <p-accordionTab header="Users Management" style="margin-bottom: 10px">
            <div class="mb-4" style="margin-bottom: 2cm">
                <div class="flex justify-between items-center mb-4">
                    <h2>Users</h2>
                    <button pButton type="button" icon="pi pi-plus" label="Add User"
                            (click)="openNewUser()" class="p-button-success"></button>
                </div>

                <!-- Search Bar -->
                <div class="p-inputgroup mb-4">
                    <span class="p-inputgroup-addon">
                        <i class="pi pi-search"></i>
                    </span>
                    <input type="text" pInputText [(ngModel)]="userSearchText"
                           (input)="filterUsers()" placeholder="Search users..." class="w-full"/>
                    <button pButton type="button" icon="pi pi-times" *ngIf="userSearchText"
                            (click)="clearUserSearch()" class="p-button-outlined"></button>
                </div>

                <!-- Users Table -->
                <!-- Users Table -->
                <p-table [value]="filteredUsers" [rows]="pageSize" [paginator]="true" [loading]="loading"
                         [rowsPerPageOptions]="[5, 10, 20, 50]" selectionMode="single"
                         [(selection)]="selectedUser" dataKey="username"
                         (onRowSelect)="onUserSelect($event.data)"
                         [totalRecords]="filteredUsers.length"
                         [showCurrentPageReport]="true"
                         currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries">

                    <!-- Paginator Template -->
<!--                    <ng-template pTemplate="paginatorleft">-->
<!--                        <div class="flex items-center gap-2">-->
<!--                            <span class="text-sm text-surface-500">Show:</span>-->
<!--                            <p-dropdown [options]="[5, 10, 20, 50]" [(ngModel)]="pageSize"-->
<!--                                        (onChange)="onPageSizeChange()" styleClass="w-16"></p-dropdown>-->
<!--                            <span class="text-sm text-surface-500">entries</span>-->
<!--                        </div>-->
<!--                    </ng-template>-->

                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 120px">Username</th>
                            <th style="width: 150px">Full Name</th>
                            <th style="width: 200px">Email</th>
                            <th style="width: 120px">Actions</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-user let-rowIndex="rowIndex">
                        <tr [pSelectableRow]="user">
                            <td>{{ user.username }}</td>
                            <td>{{ user.fullName}}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                <div class="flex gap-1">
                                    <button pButton type="button" icon="pi pi-users" pTooltip="Assign Groups"
                                            (click)="openAssignmentDialog(user)"
                                            class="p-button-info p-button-sm p-button-outlined"></button>
                                    <button pButton type="button" icon="pi pi-trash" pTooltip="Delete User"
                                            (click)="deleteUser(user)"
                                            class="p-button-danger p-button-sm p-button-outlined"></button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="5" class="text-center p-6">
                                <i class="pi pi-users text-4xl text-surface-300 mb-3"></i>
                                <p class="text-surface-500">No users found</p>
                                <p class="text-surface-400 text-sm mt-1" *ngIf="userSearchText">
                                    No users match "{{ userSearchText }}"
                                </p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <!-- Selected User Details -->
            <div *ngIf="selectedUser" class="card mt-4">
                <div class="flex justify-between items-center mb-4">
                    <h3>User Details: {{ selectedUser.username }}</h3>
                    <button pButton type="button" icon="pi pi-refresh" label="Refresh Groups"
                            (click)="refreshUserGroups()" [loading]="userGroupsLoading"
                            class="p-button-outlined p-button-sm"></button>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <strong>Username:</strong> {{ selectedUser.username }}
                    </div>
                    <div>
                        <strong>Full Name:</strong> {{ selectedUser.firstName }} {{ selectedUser.lastName }}
                    </div>
                    <div>
                        <strong>Email:</strong> {{ selectedUser.email }}
                    </div>
                    <div>
                        <strong>Total Groups:</strong> {{ userGroups.length }}
                    </div>
                </div>

                <!-- User Groups Section -->
                <div class="mt-4">
                    <h4 class="font-semibold mb-3">Assigned Groups</h4>

                    <!-- Loading state -->
                    <div *ngIf="userGroupsLoading" class="flex justify-center items-center p-4">
                        <p-progressSpinner styleClass="w-6 h-6"></p-progressSpinner>
                        <span class="ml-2">Loading groups...</span>
                    </div>

                    <!-- No groups state -->
                    <div *ngIf="!userGroupsLoading && userGroups.length === 0" class="text-center p-4 bg-surface-50 rounded">
                        <i class="pi pi-users text-2xl text-surface-300 mb-2"></i>
                        <p class="text-surface-500">No groups assigned to this user</p>
                    </div>

                    <!-- Groups list -->
                    <div *ngIf="!userGroupsLoading && userGroups.length > 0" class="grid gap-2">
                        <div *ngFor="let group of userGroups" class="flex items-center justify-between p-3 border border-surface-200 rounded">
                            <div class="flex items-center gap-3">
                                <i class="pi pi-users text-primary-500"></i>
                                <div>
                                    <div class="font-medium">{{ group.name }}</div>
                                    <div class="text-sm text-surface-500">{{ group.memberCount || 0 }} members</div>
                                </div>
                            </div>
                            <button pButton type="button" icon="pi pi-times"
                                    (click)="removeUserFromGroup(group)"
                                    class="p-button-danger p-button-text p-button-sm"
                                    pTooltip="Remove from group">
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </p-accordionTab>

        <!-- Spacer -->
<!--        <div style="height: 5cm; background: transparent;"></div>-->

        <!-- Groups Section -->
        <p-accordionTab header="Groups Management" style="margin-bottom: 10px">
            <div class="mb-4" style="margin-bottom: 1cm">
                <div class="flex justify-between items-center mb-4">
                    <h2>Groups</h2>
                    <button pButton type="button" icon="pi pi-plus" label="Add Group"
                            (click)="openNewGroup()" class="p-button-success"></button>
                </div>

                <!-- Search Bar -->
                <div class="p-inputgroup mb-4">
                    <span class="p-inputgroup-addon">
                        <i class="pi pi-search"></i>
                    </span>
                    <input type="text" pInputText [(ngModel)]="groupSearchText"
                           (input)="filterGroups()" placeholder="Search groups..." class="w-full"/>
                    <button pButton type="button" icon="pi pi-times" *ngIf="groupSearchText"
                            (click)="clearGroupSearch()" class="p-button-outlined"></button>
                </div>

                <!-- Groups Table -->
                <p-table [value]="filteredGroups" [rows]="10" [paginator]="true" [loading]="loading"
                         [rowsPerPageOptions]="[5, 10, 20]" selectionMode="single"
                         [(selection)]="selectedGroup" dataKey="name"
                         (onRowSelect)="onGroupSelect($event.data)">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Group Name</th>
                            <th>Member Count</th>
                            <th>Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-group>
                        <tr [pSelectableRow]="group">
                            <td>{{ group.name }}</td>
                            <td>{{ group.memberCount || 0 }}</td>
                            <td>
                                <button pButton type="button" icon="pi pi-trash"
                                        (click)="deleteGroup(group)"
                                        class="p-button-danger p-button-sm"></button>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="3" class="text-center p-4">
                                No groups found
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <!-- Selected Group Details -->
            <div *ngIf="selectedGroup" class="card mt-4">
                <h3>Group Details: {{ selectedGroup.name }}</h3>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <strong>Group Name:</strong> {{ selectedGroup.name }}
                    </div>
                    <div>
                        <strong>Member Count:</strong> {{ selectedGroup.memberCount || 0 }}
                    </div>
                </div>
            </div>
        </p-accordionTab>
    </p-accordion>

    <!-- User Dialog -->
    <p-dialog [(visible)]="userDialog" [style]="{width: '500px'}" header="Add New User">
        <div class="p-fluid">
            <div class="field">
                <label for="username">Username *</label>
                <input id="username" pInputText [(ngModel)]="userForm.username" required
                       [class]="submitted && !userForm.username ? 'ng-invalid ng-dirty' : ''" />
                <small *ngIf="submitted && !userForm.username" class="p-error">Username is required</small>
            </div>

            <div class="field">
                <label for="password">Password *</label>
                <p-password id="password" [(ngModel)]="userForm.password" required
                            [feedback]="true" [toggleMask]="true"
                            (onInput)="onPasswordInput()"
                            [class]="submitted && passwordErrors.length > 0 ? 'ng-invalid ng-dirty' : ''" />

                <!-- Password validation errors -->
                <div *ngIf="passwordErrors.length > 0" class="p-error text-sm mt-2">
                    <div *ngFor="let error of passwordErrors" class="flex items-center gap-2 mb-1">
                        <i class="pi pi-times text-red-500"></i>
                        <span>{{ error }}</span>
                    </div>
                </div>

                <!-- Password requirements hint -->
                <small class="text-surface-500">Must include: 8+ characters, uppercase, lowercase, number, special character</small>
            </div>

            <div class="field">
                <label for="email">Email *</label>
                <input id="email" pInputText [(ngModel)]="userForm.email" type="email" required
                       (input)="onEmailInput()"
                       [class]="submitted && emailError ? 'ng-invalid ng-dirty' : ''" />
                <small *ngIf="emailError" class="p-error">{{ emailError }}</small>
            </div>

            <div class="field">
                <label for="firstName">First Name</label>
                <input id="firstName" pInputText [(ngModel)]="userForm.firstName" />
            </div>

            <div class="field">
                <label for="lastName">Last Name</label>
                <input id="lastName" pInputText [(ngModel)]="userForm.lastName" />
            </div>
        </div>
        <ng-template pTemplate="footer">
            <button pButton type="button" label="Cancel" icon="pi pi-times"
                    (click)="userDialog = false; resetForm();" class="p-button-text"></button>
            <button pButton type="button" label="Create" icon="pi pi-check"
                    (click)="createUser()" class="p-button-success"></button>
        </ng-template>
    </p-dialog>
    <!-- Group Dialog -->
    <p-dialog [(visible)]="groupDialog" [style]="{width: '350px'}" header="Add New Group">
        <div class="p-fluid">
            <div class="field">
                <label for="name">Group Name *</label>
                <input id="groupName" pInputText [(ngModel)]="groupForm.name" required />
            </div>
        </div>
        <ng-template pTemplate="footer">
            <button pButton type="button" label="Cancel" icon="pi pi-times"
                    (click)="groupDialog = false" class="p-button-text"></button>
            <button pButton type="button" label="Create" icon="pi pi-check"
                    (click)="createGroup()" class="p-button-success"></button>
        </ng-template>
    </p-dialog>

    <!-- Assignment Dialog -->
    <!-- Assignment Dialog -->
    <p-dialog [(visible)]="assignmentDialog" [style]="{ width: '90vw', maxWidth: '600px' }"
              [contentStyle]="{ 'max-height': '70vh' }" [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
              header="Assign Groups to {{ selectedUser?.username }}" [modal]="true" [draggable]="false" [resizable]="false">

        <div class="p-fluid flex flex-col gap-4" style="min-height: 300px;">
            <!-- Selected Groups List -->
            <div *ngIf="selectedGroupsForAssignment.length > 0" class="flex flex-col">
                <h4 class="font-semibold mb-2">Selected Groups ({{ selectedGroupsForAssignment.length }}):</h4>
                <div class="selected-groups-container border border-surface-200 rounded p-3 bg-surface-50 max-h-32 overflow-y-auto">
                    <div class="flex flex-wrap gap-2">
                        <p-tag *ngFor="let group of selectedGroupsForAssignment"
                               [value]="group.name"
                               severity="success"
                               styleClass="text-sm py-1">
                            <i class="pi pi-times ml-2 cursor-pointer text-xs"
                               (click)="removeGroupFromSelection(group)"></i>
                        </p-tag>
                    </div>
                </div>
            </div>

            <!-- Group Selection -->
            <div class="field flex flex-col flex-1 min-h-48">
                <label class="font-medium mb-2">Select Groups</label>
                <p-multiSelect [options]="groups" [(ngModel)]="selectedGroupsForAssignment"
                               optionLabel="name" placeholder="Select groups..."
                               [filter]="true" filterPlaceholder="Search groups..."
                               [virtualScroll]="true" [showToggleAll]="false"
                               [maxSelectedLabels]="3" [selectedItemsLabel]="'{0} groups selected'"
                               class="w-full">
                    <ng-template let-group pTemplate="item">
                        <div class="flex items-center justify-between p-2">
                            <span class="font-medium">{{ group.name }}</span>
                            <small class="text-surface-500 text-xs">({{ group.memberCount || 0 }} members)</small>
                        </div>
                    </ng-template>
                </p-multiSelect>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-2 gap-4 text-sm text-surface-600">
                <div class="text-center p-2 bg-surface-100 rounded">
                    <div class="font-semibold text-lg">{{ groups.length }}</div>
                    <div>Total Groups</div>
                </div>
                <div class="text-center p-2 bg-surface-100 rounded">
                    <div class="font-semibold text-lg">{{ selectedGroupsForAssignment.length }}</div>
                    <div>Selected</div>
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <div class="flex justify-between items-center w-full">
            <span class="text-sm text-surface-500" *ngIf="selectedGroupsForAssignment.length > 0">
                {{ selectedGroupsForAssignment.length }} group(s) selected
            </span>
                <span class="text-sm text-surface-500" *ngIf="selectedGroupsForAssignment.length === 0">
                No groups selected
            </span>
                <div class="flex gap-2">
                    <button pButton type="button" label="Cancel" icon="pi pi-times"
                            (click)="assignmentDialog = false" class="p-button-text p-button-sm"></button>
                    <button pButton type="button" label="Assign" icon="pi pi-check"
                            (click)="assignGroupsToUser()" class="p-button-success p-button-sm"
                            [disabled]="selectedGroupsForAssignment.length === 0"></button>
                </div>
            </div>
        </ng-template>
    </p-dialog>
</div>