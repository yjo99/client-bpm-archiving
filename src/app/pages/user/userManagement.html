<!-- userManagement.html -->
<app-floating-configurator />
<style>
    /* Add to your component's CSS */
    .selected-groups-container {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    ::ng-deep .p-dialog-content {
        overflow-y: auto !important;
    }

    ::ng-deep .p-multiselect-panel {
        max-height: 200px !important;
    }

    .flex-wrap {
        flex-wrap: wrap;
    }

    .gap-1 {
        gap: 0.25rem;
    }

    .max-h-32 {
        max-height: 8rem;
    }
</style>
<div class="p-4">
    <p-toast></p-toast>

    <div class="card mb-6">
        <h1>User Management Screen</h1>
    </div>

    <p-accordion [activeIndex]="activeIndex">
        <!-- Users Section -->
        <p-accordionTab header="Users Management" style="margin-bottom: 10px">
            <div class="mb-4" style="margin-bottom: 2cm">
                <div class="flex justify-between items-center mb-4">
                    <h2>Users</h2>
                    <button pButton type="button" icon="pi pi-plus" label="Add User"
                            (click)="openNewUser()" class="p-button-success"></button>
                </div>

                <!-- Search Bar -->
                <div class="p-inputgroup mb-4">
                    <span class="p-inputgroup-addon">
                        <i class="pi pi-search"></i>
                    </span>
                    <input type="text" pInputText [(ngModel)]="userSearchText"
                           (input)="filterUsers()" placeholder="Search users..." class="w-full"/>
                    <button pButton type="button" icon="pi pi-times" *ngIf="userSearchText"
                            (click)="clearUserSearch()" class="p-button-outlined"></button>
                </div>

                <!-- Users Table -->
                <!-- Users Table -->
                <p-table [value]="filteredUsers" [rows]="pageSize" [paginator]="true" [loading]="loading"
                         [rowsPerPageOptions]="[5, 10, 20, 50]" selectionMode="single"
                         [(selection)]="selectedUser" dataKey="username"
                         (onRowSelect)="onUserSelect($event.data)"
                         [totalRecords]="filteredUsers.length"
                         [showCurrentPageReport]="true"
                         currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries">

                    <!-- Paginator Template -->
<!--                    <ng-template pTemplate="paginatorleft">-->
<!--                        <div class="flex items-center gap-2">-->
<!--                            <span class="text-sm text-surface-500">Show:</span>-->
<!--                            <p-dropdown [options]="[5, 10, 20, 50]" [(ngModel)]="pageSize"-->
<!--                                        (onChange)="onPageSizeChange()" styleClass="w-16"></p-dropdown>-->
<!--                            <span class="text-sm text-surface-500">entries</span>-->
<!--                        </div>-->
<!--                    </ng-template>-->

                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 120px">Username</th>
                            <th style="width: 150px">Full Name</th>
                            <th style="width: 200px">Email</th>
                            <th style="width: 120px">Actions</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-user let-rowIndex="rowIndex">
                        <tr [pSelectableRow]="user">
                            <td>{{ user.username }}</td>
                            <td>{{ user.fullName}}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                <div class="flex gap-1">
                                    <button pButton type="button" icon="pi pi-users" pTooltip="Assign Groups"
                                            (click)="openAssignmentDialog(user)"
                                            class="p-button-info p-button-sm p-button-outlined"></button>
                                    <button pButton type="button" icon="pi pi-trash" pTooltip="Delete User"
                                            (click)="deleteUser(user)"
                                            class="p-button-danger p-button-sm p-button-outlined"></button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="5" class="text-center p-6">
                                <i class="pi pi-users text-4xl text-surface-300 mb-3"></i>
                                <p class="text-surface-500">No users found</p>
                                <p class="text-surface-400 text-sm mt-1" *ngIf="userSearchText">
                                    No users match "{{ userSearchText }}"
                                </p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <!-- Selected User Details -->
            <div *ngIf="selectedUser" class="card mt-4">
                <h3>User Details: {{ selectedUser.username }}</h3>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <strong>Username:</strong> {{ selectedUser.username }}
                    </div>
                    <div>
                        <strong>Full Name:</strong> {{ selectedUser.firstName }} {{ selectedUser.lastName }}
                    </div>
                    <div>
                        <strong>Email:</strong> {{ selectedUser.email }}
                    </div>
                </div>
            </div>
        </p-accordionTab>

        <!-- Spacer -->
<!--        <div style="height: 5cm; background: transparent;"></div>-->

        <!-- Groups Section -->
        <p-accordionTab header="Groups Management" style="margin-bottom: 10px">
            <div class="mb-4" style="margin-bottom: 1cm">
                <div class="flex justify-between items-center mb-4">
                    <h2>Groups</h2>
                    <button pButton type="button" icon="pi pi-plus" label="Add Group"
                            (click)="openNewGroup()" class="p-button-success"></button>
                </div>

                <!-- Search Bar -->
                <div class="p-inputgroup mb-4">
                    <span class="p-inputgroup-addon">
                        <i class="pi pi-search"></i>
                    </span>
                    <input type="text" pInputText [(ngModel)]="groupSearchText"
                           (input)="filterGroups()" placeholder="Search groups..." class="w-full"/>
                    <button pButton type="button" icon="pi pi-times" *ngIf="groupSearchText"
                            (click)="clearGroupSearch()" class="p-button-outlined"></button>
                </div>

                <!-- Groups Table -->
                <p-table [value]="filteredGroups" [rows]="10" [paginator]="true" [loading]="loading"
                         [rowsPerPageOptions]="[5, 10, 20]" selectionMode="single"
                         [(selection)]="selectedGroup" dataKey="name"
                         (onRowSelect)="onGroupSelect($event.data)">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Group Name</th>
                            <th>Member Count</th>
                            <th>Actions</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-group>
                        <tr [pSelectableRow]="group">
                            <td>{{ group.name }}</td>
                            <td>{{ group.memberCount || 0 }}</td>
                            <td>
                                <button pButton type="button" icon="pi pi-trash"
                                        (click)="deleteGroup(group)"
                                        class="p-button-danger p-button-sm"></button>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="3" class="text-center p-4">
                                No groups found
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>

            <!-- Selected Group Details -->
            <div *ngIf="selectedGroup" class="card mt-4">
                <h3>Group Details: {{ selectedGroup.name }}</h3>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <strong>Group Name:</strong> {{ selectedGroup.name }}
                    </div>
                    <div>
                        <strong>Member Count:</strong> {{ selectedGroup.memberCount || 0 }}
                    </div>
                </div>
            </div>
        </p-accordionTab>
    </p-accordion>

    <!-- User Dialog -->
    <p-dialog [(visible)]="userDialog" [style]="{width: '500px'}" header="Add New User">
        <div class="p-fluid">
            <div class="field">
                <label for="username">Username *</label>
                <input id="username" pInputText [(ngModel)]="userForm.username" required
                       [class]="submitted && !userForm.username ? 'ng-invalid ng-dirty' : ''" />
                <small *ngIf="submitted && !userForm.username" class="p-error">Username is required</small>
            </div>

            <div class="field">
                <label for="password">Password *</label>
                <p-password id="password" [(ngModel)]="userForm.password" required
                            [feedback]="true" [toggleMask]="true"
                            (onInput)="onPasswordInput()"
                            [class]="submitted && passwordErrors.length > 0 ? 'ng-invalid ng-dirty' : ''" />

                <!-- Password validation errors -->
                <div *ngIf="passwordErrors.length > 0" class="p-error text-sm mt-2">
                    <div *ngFor="let error of passwordErrors" class="flex items-center gap-2 mb-1">
                        <i class="pi pi-times text-red-500"></i>
                        <span>{{ error }}</span>
                    </div>
                </div>

                <!-- Password requirements hint -->
                <small class="text-surface-500">Must include: 8+ characters, uppercase, lowercase, number, special character</small>
            </div>

            <div class="field">
                <label for="email">Email *</label>
                <input id="email" pInputText [(ngModel)]="userForm.email" type="email" required
                       (input)="onEmailInput()"
                       [class]="submitted && emailError ? 'ng-invalid ng-dirty' : ''" />
                <small *ngIf="emailError" class="p-error">{{ emailError }}</small>
            </div>

            <div class="field">
                <label for="firstName">First Name</label>
                <input id="firstName" pInputText [(ngModel)]="userForm.firstName" />
            </div>

            <div class="field">
                <label for="lastName">Last Name</label>
                <input id="lastName" pInputText [(ngModel)]="userForm.lastName" />
            </div>
        </div>
        <ng-template pTemplate="footer">
            <button pButton type="button" label="Cancel" icon="pi pi-times"
                    (click)="userDialog = false; resetForm();" class="p-button-text"></button>
            <button pButton type="button" label="Create" icon="pi pi-check"
                    (click)="createUser()" class="p-button-success"></button>
        </ng-template>
    </p-dialog>
    <!-- Group Dialog -->
    <p-dialog [(visible)]="groupDialog" [style]="{width: '350px'}" header="Add New Group">
        <div class="p-fluid">
            <div class="field">
                <label for="name">Group Name *</label>
                <input id="groupName" pInputText [(ngModel)]="groupForm.name" required />
            </div>
        </div>
        <ng-template pTemplate="footer">
            <button pButton type="button" label="Cancel" icon="pi pi-times"
                    (click)="groupDialog = false" class="p-button-text"></button>
            <button pButton type="button" label="Create" icon="pi pi-check"
                    (click)="createGroup()" class="p-button-success"></button>
        </ng-template>
    </p-dialog>

    <!-- Assignment Dialog -->
    <p-dialog [(visible)]="assignmentDialog" [style]="{width: '600px', height: '1000px'}"
              header="Assign Groups to {{ selectedUser?.username }}" [modal]="true">
        <div class="p-fluid h-full flex flex-col">
            <!-- Selected Groups List -->
            <div class="mb-4" *ngIf="selectedGroupsForAssignment.length > 0">
                <h4 class="font-semibold mb-2">Selected Groups:</h4>
                <div class="selected-groups-container border rounded p-3 max-h-32 overflow-y-auto">
                    <p-tag *ngFor="let group of selectedGroupsForAssignment"
                           [value]="group.name"
                           severity="success"
                           class="mr-2 mb-2">
                        <i class="pi pi-times ml-2 cursor-pointer"
                           (click)="removeGroupFromSelection(group)"></i>
                    </p-tag>
                </div>
            </div>

            <!-- Group Selection -->
            <div class="field flex-1">
                <label>Select Groups</label>
                <p-multiSelect [options]="groups" [(ngModel)]="selectedGroupsForAssignment"
                               optionLabel="name" placeholder="Select groups"
                               [filter]="true" filterPlaceholder="Search groups..."
                               [virtualScroll]="true" [showToggleAll]="false"
                               class="w-full h-full">
                    <ng-template let-group pTemplate="item">
                        <div class="flex items-center justify-between">
                            <span>{{ group.name }}</span>
                            <small class="text-surface-500">({{ group.memberCount || 0 }} members)</small>
                        </div>
                    </ng-template>
                </p-multiSelect>
            </div>

            <!-- Available Groups Count -->
            <div class="text-sm text-surface-500 mt-2">
                {{ groups.length }} groups available
            </div>
        </div>
        <ng-template pTemplate="footer">
            <button pButton type="button" label="Cancel" icon="pi pi-times"
                    (click)="assignmentDialog = false" class="p-button-text"></button>
            <button pButton type="button" label="Assign Selected Groups" icon="pi pi-check"
                    (click)="assignGroupsToUser()" class="p-button-success"
                    [disabled]="selectedGroupsForAssignment.length === 0"></button>
        </ng-template>
    </p-dialog>
</div>